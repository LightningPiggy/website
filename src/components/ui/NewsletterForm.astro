---
interface Props {
  variant?: 'light' | 'dark';
  class?: string;
}

const { variant = 'light', class: className = '' } = Astro.props;
const isDark = variant === 'dark';
---

<form class:list={['newsletter-form', className]} data-buttondown-username="satoshi">
  <div class="flex flex-col sm:flex-row gap-2">
    <input
      type="email"
      name="email"
      placeholder="Enter your email"
      required
      class:list={[
        'flex-1 px-4 py-2.5 rounded-lg text-sm focus:outline-none focus:ring-2 transition-colors',
        isDark
          ? 'bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:ring-white/30 focus:border-white/40'
          : 'bg-white border border-gray-300 text-gray-900 placeholder-gray-500 focus:ring-pink/30 focus:border-pink'
      ]}
    />
    <input type="hidden" name="embed" value="1" />
    <button
      type="submit"
      class:list={[
        'px-5 py-2.5 rounded-lg text-sm font-semibold transition-all focus:outline-none focus:ring-2 disabled:opacity-50 disabled:cursor-not-allowed',
        isDark
          ? 'bg-white text-gray-900 hover:bg-gray-100 focus:ring-white/50'
          : 'bg-pink text-white hover:bg-pink-dark focus:ring-pink/50'
      ]}
    >
      <span class="btn-text">Subscribe</span>
      <span class="btn-loading hidden">
        <svg class="animate-spin h-4 w-4 mx-auto" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      </span>
    </button>
  </div>
  <p class:list={[
    'newsletter-message mt-2 text-sm hidden',
    isDark ? 'text-gray-300' : 'text-gray-600'
  ]}></p>
</form>

<script>
  document.querySelectorAll('.newsletter-form').forEach((form) => {
    const formEl = form as HTMLFormElement;
    const username = formEl.dataset.buttondownUsername;

    // Create hidden iframe for form submission
    const iframeName = `buttondown-iframe-${Math.random().toString(36).slice(2)}`;
    const iframe = document.createElement('iframe');
    iframe.name = iframeName;
    iframe.style.display = 'none';
    document.body.appendChild(iframe);

    // Set form to submit to iframe
    formEl.action = `https://buttondown.com/api/emails/embed-subscribe/${username}`;
    formEl.method = 'POST';
    formEl.target = iframeName;

    formEl.addEventListener('submit', (e) => {
      const emailInput = formEl.querySelector('input[name="email"]') as HTMLInputElement;
      const submitBtn = formEl.querySelector('button[type="submit"]') as HTMLButtonElement;
      const btnText = submitBtn.querySelector('.btn-text') as HTMLElement;
      const btnLoading = submitBtn.querySelector('.btn-loading') as HTMLElement;
      const message = formEl.querySelector('.newsletter-message') as HTMLElement;

      const email = emailInput.value.trim();
      if (!email) {
        e.preventDefault();
        return;
      }

      // Show loading state
      submitBtn.disabled = true;
      btnText.classList.add('hidden');
      btnLoading.classList.remove('hidden');
      message.classList.add('hidden');

      // Show success after a brief delay (form submits to hidden iframe)
      setTimeout(() => {
        message.textContent = 'Thanks for subscribing! Please check your email to confirm.';
        message.classList.remove('hidden', 'text-red-500');
        message.classList.add('text-green-500');
        emailInput.value = '';

        // Reset button state
        submitBtn.disabled = false;
        btnText.classList.remove('hidden');
        btnLoading.classList.add('hidden');
      }, 1000);
    });
  });
</script>
